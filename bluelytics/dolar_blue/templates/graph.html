{% extends "base.html" %}
{% load staticfiles %}
{% load tz %}


{% block content %}
<h1>Dolar blue</h1>
<h2>Evolucion promedio compra/venta</h2>

<div id="dailychart">
  <div class="legend_container">
    <div class="smoother" title="Smoothing"></div>
    <div class="legend"></div>
  </div>
  <div class="chart"></div>
  <br>
  <div class="slider"></div>
</div>
{% endblock %}


{% block extrahead %}
<script src="{% static 'js/d3.v3.min.js' %}"></script>
<script src="{% static 'js/rickshaw.min.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/rickshaw.min.css' %}">

<style>
.rickshaw_graph .detail .x_label { display: none }
.rickshaw_graph .detail .item { line-height: 1.4; padding: 0.5em }
.detail_swatch { float: right; display: inline-block; width: 10px; height: 10px; margin: 0 4px 0 0 }
.rickshaw_graph .detail .date { color: #a0a0a0 }
</style>

<script>
$(document).ready (function(){
    function union(array1, array2) {
        var hash = {}, union = [];
        $.each($.merge($.merge([], array1), array2), function (index, value) { hash[value] = value; });
        $.each(hash, function (key, value) { union.push(key); } );
        return union;
    }

  var blueData = {{ all_prices|safe }};
  var sourceData = {{ all_sources|safe }};
  var format = d3.time.format("%d/%m/%Y %H:%M:%S");

  var add_20perc = blueData
    .filter(function(e){return e.source == "oficial";})
    .map(function(e){
              d=jQuery.extend({},e);
              d.source="oficial_mas20";
              d.value_avg *= 1.20;
              return d;
            })
  ;

  var add_35perc = blueData
    .filter(function(e){return e.source == "oficial";})
    .map(function(e){
                d=jQuery.extend({},e);
                d.source="oficial_mas35";
                d.value_avg *= 1.35;
                return d;
            })
  ;

  blueFixed = jQuery.merge(jQuery.merge(add_20perc, add_35perc), blueData);

  var label_20perc = {"name": "oficial_mas20", "description": "Oficial + 20%"};
  var label_35perc = {"name": "oficial_mas35", "description": "Oficial + 35%"};
  sourceData.push(label_20perc);
  sourceData.push(label_35perc);

  var transfBlueData = blueFixed.map(function(b){
    b.epoch = format.parse(b.date).getTime()/1000;
    return b;
  });

  var graphData = [];
  var palette = new Rickshaw.Color.Palette();

  for (key in sourceData){
    var source = sourceData[key].name;
    var sourceDesc = sourceData[key].description;
    srcd = {
      data: 
        transfBlueData
          .filter(function(d){return d.source == source;})
          .map(function(d){return {x: d.epoch, y:+(d.value_avg.toFixed(4))};})
      ,
      name: sourceDesc,
      color: palette.color()
    }

    graphData.push(srcd);
  }
  

  var graph = new Rickshaw.Graph( {
      element: document.querySelector("div#dailychart > div.chart"), 
      renderer: 'line',
      width: document.querySelector("div#dailychart > div.chart").width, 
      height: 300, 
      series: graphData,
      min:7
  });

  var legend = new Rickshaw.Graph.Legend({
      graph: graph,
      element: document.querySelector('div#dailychart > div.legend_container > div.legend')
  });
  var shelving = new Rickshaw.Graph.Behavior.Series.Toggle({
      graph: graph,
      legend: legend
  });
  var highlighter = new Rickshaw.Graph.Behavior.Series.Highlight({
      graph: graph,
      legend: legend
  });


  var slider = new Rickshaw.Graph.RangeSlider.Preview({
      graph: graph,
      element: document.querySelector('div#dailychart > div.slider')
  });

  var previewXAxis = new Rickshaw.Graph.Axis.Time({
    graph: slider.previews[0]
  });


  var xAxis = new Rickshaw.Graph.Axis.Time({
      graph: graph
  });

  var yAxis = new Rickshaw.Graph.Axis.Y({
      graph: graph
  });
  var hoverDetail = new Rickshaw.Graph.HoverDetail( {
    graph: graph,
    formatter: function(series, x, y) {
      var date = '<span class="date">' + new Date(x * 1000).toUTCString() + '</span>';
      var swatch = '<span class="detail_swatch" style="background-color: ' + series.color + '"></span>';
      var content = swatch + series.name + ": " + parseFloat(y) + '<br>' + date;
      return content;
    }
  } );

  previewXAxis.render();
  xAxis.render();
  yAxis.render();
  graph.render();
});
</script>
{% endblock %}
